def getRev() {
	//Git Rev
	def os = new ByteArrayOutputStream()
	def e = exec {
	    executable "git"
	    args "rev-parse"
	    args "HEAD"
	    standardOutput = os
	}
	return os.toString().substring(0, 7)
}

def HEAD = getRev()
def PATCHS = [
	"173" : ["patchs/173/0001-Revert-Compatible-with-IDEA2018.2.patch"]
]
def makePatch(v, ideaVer, patchs, rev) {
	def patchTask = tasks.create(name:"patch_${v}") {
		doLast {
			exec {
				executable "git"
				args "reset", "HEAD", "--hard"
			}
			exec {
				executable "git"
				args = ["am"] + patchs
			}
			exec {
				executable "git"
				args "reset", rev
			}
		}
	}
	tasks.create(name: "build_${v}", dependsOn:[patchTask]) {
		finalizedBy buildPlugin
		doLast {
			intellij {
				type 'IU'
				updateSinceUntilBuild false
				downloadSources false
				version = ideaVer
				localPath System.env['IDEA_HOME']
			}
		}
	}
}

makePatch("173", "IC-173.4127.27", PATCHS["173"], HEAD)